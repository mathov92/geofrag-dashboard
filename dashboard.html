<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geo√∏konomisk Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Garamond', 'Georgia', serif;
            background: #DEDEDE;
            min-height: 100vh;
            padding: 20px;
        }
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #5A1C26;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.8em;
            font-weight: normal;
            letter-spacing: 0.02em;
        }
        .status-bar {
            background: #EE3A36;
            border-radius: 4px;
            padding: 12px 24px;
            margin-bottom: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status { 
            font-size: 0.95em;
            letter-spacing: 0.01em;
        }
        .live-indicator {
            width: 10px;
            height: 10px;
            background: #6A8F7F;
            border-radius: 50%;
            animation: pulse 2s infinite;
            display: inline-block;
            margin-left: 10px;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .print-button {
            background: white;
            color: #5A1C26;
            border: 2px solid white;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.9em;
            cursor: pointer;
            font-family: 'Garamond', 'Georgia', serif;
            transition: all 0.3s ease;
        }
        
        .print-button:hover {
            background: #5A1C26;
            color: white;
            transform: translateY(-1px);
        }
        .wide-card {
            background: white;
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(77, 77, 77, 0.15);
            transition: transform 0.3s ease;
            border: 1px solid #E8E8E8;
            margin-bottom: 20px;
            position: relative;
            max-height: 480px;
        }
        .wide-card:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(77, 77, 77, 0.2);
        }
        .wide-card h2 {
            color: #5A1C26;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: normal;
            letter-spacing: 0.01em;
        }
        
        /* Country selector dropdown styles */
        .country-selector {
            position: relative;
            display: inline-block;
            float: right;
            margin-top: -10px;
        }
        
        .dropdown-button {
            background: white;
            border: 1px solid #2A6965;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.85em;
            cursor: pointer;
            font-family: 'Garamond', 'Georgia', serif;
            color: #2A6965;
            min-width: 150px;
            text-align: left;
            position: relative;
            padding-right: 25px;
        }
        
        .dropdown-button:after {
            content: '‚ñº';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7em;
        }
        
        .dropdown-button:hover {
            background: #F5F5F5;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            background: white;
            min-width: 200px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 1px solid #E8E8E8;
            border-radius: 4px;
            z-index: 100;
            right: 0;
            margin-top: 2px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .dropdown-content.show {
            display: block;
        }
        
        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #F5F5F5;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background: #F5F5F5;
        }
        
        .dropdown-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .dropdown-item label {
            cursor: pointer;
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        .country-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-left: auto;
            border: 1px solid #E8E8E8;
        }
        
        .wide-card .chart-wrapper {
            height: 240px;
            position: relative;
            margin-bottom: 10px;
            padding-top: 10px;
        }
        .wide-card canvas {
            max-height: 240px !important;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(77, 77, 77, 0.15);
            transition: transform 0.3s ease;
            border: 1px solid #E8E8E8;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .card:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(77, 77, 77, 0.2);
        }
        .card h2 {
            color: #5A1C26;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: normal;
            letter-spacing: 0.01em;
        }
        .card .chart-wrapper {
            flex: 1;
            position: relative;
            min-height: 240px;
            max-height: 280px;
            margin-bottom: 10px;
        }
        .card canvas {
            max-height: 280px !important;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 10px;
            background: #F5F5F5;
            border-radius: 4px;
            border: 1px solid #E8E8E8;
            font-size: 0.9em;
        }
        .metric-value {
            font-size: 1.05em;
            font-weight: bold;
            color: #2A6965;
        }
        .trend {
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.7em;
            font-weight: bold;
        }
        .trend.up { background: #FFEBE9; color: #EE3A36; }
        .trend.down { background: #E8F4F0; color: #2A6965; }
        .loading {
            text-align: center;
            padding: 40px;
            color: #4D4D4D;
        }
        .citation {
            font-size: 0.75em;
            color: #6D6D6D;
            font-style: italic;
            margin-top: 10px;
            line-height: 1.4;
            letter-spacing: 0.01em;
        }
        
        /* Metrics grid for wide card */
        .wide-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-top: 5px;
            padding-top: 5px;
        }
        
        .wide-metrics-grid .metric {
            margin: 0;
            padding: 8px;
            font-size: 0.85em;
        }
        
        .wide-metrics-grid .metric-value {
            font-size: 1em;
        }
        
        /* Dual Range Slider Styles */
        .slider-container {
            margin: 10px auto 10px;
            width: 85%;
            max-width: 400px;
            padding: 0;
        }
        
        .wide-card .slider-container {
            margin: 5px auto 5px;
            max-width: 450px;
        }
        
        .slider-wrapper {
            position: relative;
            height: 25px;
            margin: 10px 0 5px 0;
        }
        
        .slider-track {
            position: absolute;
            width: 100%;
            height: 4px;
            background: #E8E8E8;
            border-radius: 2px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .slider-range {
            position: absolute;
            height: 4px;
            background: #2A6965;
            border-radius: 2px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .slider-left, .slider-right {
            position: absolute;
            width: 100%;
            height: 4px;
            background: transparent;
            pointer-events: none;
            top: 50%;
            transform: translateY(-50%);
            -webkit-appearance: none;
        }
        
        .slider-left::-webkit-slider-thumb,
        .slider-right::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #2A6965;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            pointer-events: all;
            position: relative;
            z-index: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .slider-left::-moz-range-thumb,
        .slider-right::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #2A6965;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            pointer-events: all;
            position: relative;
            z-index: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.7em;
            color: #5A1C26;
        }
        
        .slider-value-display {
            text-align: center;
            margin-top: 2px;
            font-size: 0.8em;
            color: #2A6965;
            font-weight: 500;
        }
        
        /* Print styles */
        @media print {
            body {
                background: white;
                padding: 0;
                margin: 0;
                font-size: 11pt;
            }
            
            .dashboard {
                max-width: 100%;
                padding: 10mm 15mm;
            }
            
            h1 {
                font-size: 18pt;
                margin-bottom: 10px;
                page-break-after: avoid;
                text-align: center;
            }
            
            .status-bar {
                display: none;
            }
            
            .print-button {
                display: none;
            }
            
            /* Wide card for trade openness - single column */
            .wide-card {
                page-break-inside: avoid;
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #999;
                margin-bottom: 15px;
                padding: 10px;
                max-height: none;
                width: 100%;
            }
            
            .wide-card h2 {
                font-size: 11pt;
                margin-bottom: 8px;
            }
            
            /* Trade chart wrapper and canvas */
            .wide-card .chart-wrapper {
                height: 140px !important;
                max-height: 140px !important;
                width: 100% !important;
                padding-top: 0;
                margin-bottom: 8px;
                position: relative;
            }
            
            .wide-card canvas {
                max-height: 140px !important;
                height: 140px !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Grid layout - SINGLE COLUMN for print */
            .grid {
                display: block !important;
                page-break-before: avoid;
            }
            
            /* Individual cards - one per row */
            .card {
                page-break-inside: avoid;
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #999;
                padding: 10px;
                margin-bottom: 15px;
                display: block !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Special page break rules */
            .card:nth-child(1) {
                page-break-before: avoid;
            }
            
            .card:nth-child(2) {
                page-break-before: always;
            }
            
            .card:nth-child(3) {
                page-break-before: avoid;
            }
            
            .card:nth-child(4) {
                page-break-before: always;
            }
            
            .card:nth-child(5) {
                page-break-before: avoid;
            }
            
            .card h2 {
                font-size: 11pt;
                margin-bottom: 8px;
            }
            
            /* Chart dimensions for grid cards */
            .card .chart-wrapper {
                height: 160px !important;
                min-height: 160px !important;
                max-height: 160px !important;
                width: 100% !important;
                margin-bottom: 8px;
                position: relative;
            }
            
            .card canvas {
                max-height: 160px !important;
                height: 160px !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Hide sliders in print */
            .slider-container {
                display: none !important;
            }
            
            /* Hide country selector in print */
            .country-selector {
                display: none !important;
            }
            
            /* Metrics grid adjustments */
            .wide-metrics-grid {
                margin-top: 8px;
                page-break-inside: avoid;
                padding-top: 0;
                gap: 4px;
                display: grid;
                grid-template-columns: repeat(3, 1fr);
            }
            
            .metric {
                background: #f9f9f9;
                border: 1px solid #ccc;
                padding: 4px 6px;
                font-size: 8pt;
                margin: 0;
            }
            
            .metric-value {
                font-size: 9pt;
            }
            
            .trend {
                font-size: 6pt;
                padding: 1px 2px;
            }
            
            /* Citations */
            .citation {
                font-size: 7pt;
                color: #666;
                page-break-inside: avoid;
                margin-top: 5px;
                font-style: italic;
            }
            
            /* Hide interactive elements */
            .slider-left, .slider-right, .slider-track, .slider-range {
                display: none !important;
            }
            
            /* Ensure live indicator is hidden */
            .live-indicator {
                display: none !important;
            }
            
            /* Chart.js specific adjustments for print */
            canvas {
                image-rendering: optimizeQuality;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Page setup */
            @page {
                size: A4 portrait;
                margin: 15mm 10mm;
            }
            
            @page:first {
                margin-top: 10mm;
            }
        }
        
        /* Responsive adjustments */
        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .wide-metrics-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (min-width: 1200px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <h1>Geo√∏konomisk Dashboard</h1>
        
        <div class="status-bar">
            <div class="status">
                <span id="dataStatus">Loading data...</span>
                <span class="live-indicator" id="liveIndicator" style="display:none;"></span>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <button id="printButton" class="print-button" onclick="window.print()">
                    üìÑ Print til PDF
                </button>
                <div class="status">Sidste opdatering: <span id="lastUpdate">--</span></div>
            </div>
        </div>

        <!-- Trade Openness Chart - Full Width but Reduced Height -->
        <div class="wide-card">
            <h2>Handels√•benhed (Handel/BNP %)
                <div class="country-selector">
                    <button class="dropdown-button" id="countryDropdownBtn">
                        V√¶lg lande ‚ñº
                    </button>
                    <div class="dropdown-content" id="countryDropdown">
                        <div class="dropdown-item">
                            <label>
                                <input type="checkbox" value="World" checked> Verden
                                <span class="country-color" style="background: #4D4D4D;"></span>
                            </label>
                        </div>
                        <div class="dropdown-item">
                            <label>
                                <input type="checkbox" value="EU" checked> EU
                                <span class="country-color" style="background: #F5D547;"></span>
                            </label>
                        </div>
                        <div class="dropdown-item">
                            <label>
                                <input type="checkbox" value="Denmark" checked> Danmark
                                <span class="country-color" style="background: #C60C30;"></span>
                            </label>
                        </div>
                        <div class="dropdown-item">
                            <label>
                                <input type="checkbox" value="China" checked> Kina
                                <span class="country-color" style="background: #EE3A36;"></span>
                            </label>
                        </div>
                        <div class="dropdown-item">
                            <label>
                                <input type="checkbox" value="India" checked> Indien
                                <span class="country-color" style="background: #FF9933;"></span>
                            </label>
                        </div>
                        <div class="dropdown-item">
                            <label>
                                <input type="checkbox" value="USA" checked> USA
                                <span class="country-color" style="background: #005A8C;"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </h2>
            <div class="slider-container">
                <div class="slider-wrapper">
                    <div class="slider-track"></div>
                    <div class="slider-range" id="tradeRange"></div>
                    <input type="range" class="slider-left" id="tradeMin" min="2000" max="2024" value="2000">
                    <input type="range" class="slider-right" id="tradeMax" min="2000" max="2024" value="2024">
                </div>
                <div class="slider-labels">
                    <span>2000</span>
                    <span>2024</span>
                </div>
                <div class="slider-value-display" id="tradeDisplay">2000 - 2024</div>
            </div>
            <div class="chart-wrapper">
                <canvas id="tradeOpennessChart"></canvas>
            </div>
            <div class="wide-metrics-grid">
                <div class="metric">
                    <span>Verden</span>
                    <span class="metric-value" id="worldTrade">--</span>
                    <span class="trend down" id="worldTradeTrend">--</span>
                </div>
                <div class="metric">
                    <span>EU</span>
                    <span class="metric-value" id="euTrade">--</span>
                    <span class="trend down" id="euTradeTrend">--</span>
                </div>
                <div class="metric">
                    <span>Kina</span>
                    <span class="metric-value" id="chinaTrade">--</span>
                    <span class="trend up" id="chinaTradeTrend">--</span>
                </div>
                <div class="metric">
                    <span>USA</span>
                    <span class="metric-value" id="usaTrade">--</span>
                    <span class="trend up" id="usaTradeTrend">--</span>
                </div>
                <div class="metric">
                    <span>Indien</span>
                    <span class="metric-value" id="indiaTrade">--</span>
                    <span class="trend up" id="indiaTradeTrend">--</span>
                </div>
                <div class="metric">
                    <span>Danmark</span>
                    <span class="metric-value" id="denmarkTrade">--</span>
                    <span class="trend up" id="denmarkTradeTrend">--</span>
                </div>
            </div>
            <div class="citation">
                Source: World Bank - Trade (% of GDP) Indicator
            </div>
        </div>

        <div class="grid">
            <!-- Currency Usage Trends - NO SLIDER -->
            <div class="card">
                <h2>Reservevaluta Status</h2>
                <div class="chart-wrapper">
                    <canvas id="currencyChart"></canvas>
                </div>
                <div class="metric">
                    <span>USD Dominance</span>
                    <span class="metric-value" id="usdShare">--</span>
                </div>
                <div class="citation">
                    Source: IMF Currency Composition of Official Foreign Exchange Reserves (COFER)
                </div>
            </div>

            <!-- FDI as % of GDP Comparison -->
            <div class="card">
                <h2>Indg√•ende FDI % af BNP (√•benhed)</h2>
                <div class="slider-container">
                    <div class="slider-wrapper">
                        <div class="slider-track"></div>
                        <div class="slider-range" id="fdiRange"></div>
                        <input type="range" class="slider-left" id="fdiMin" min="2015" max="2025" value="2015">
                        <input type="range" class="slider-right" id="fdiMax" min="2015" max="2025" value="2025">
                    </div>
                    <div class="slider-labels">
                        <span>2015</span>
                        <span>2025</span>
                    </div>
                    <div class="slider-value-display" id="fdiDisplay">2015 - 2025</div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="fdiGdpChart"></canvas>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;">
                    <div class="metric">
                        <span>USA</span>
                        <span class="metric-value" id="usaFdi">--</span>
                        <span class="trend down" id="usaTrend">--</span>
                    </div>
                    <div class="metric">
                        <span>Kina</span>
                        <span class="metric-value" id="chinaFdi">--</span>
                        <span class="trend down" id="chinaTrend">--</span>
                    </div>
                    <div class="metric">
                        <span>EU</span>
                        <span class="metric-value" id="euFdi">--</span>
                        <span class="trend down" id="euTrend">--</span>
                    </div>
                </div>
                <div class="citation">
                    Source: World Bank Foreign Direct Investment Database
                </div>
            </div>

            <!-- Harmful Trade Restrictions -->
            <div class="card">
                <h2>Skadelige handelsrestriktioner</h2>
                <div class="slider-container">
                    <div class="slider-wrapper">
                        <div class="slider-track"></div>
                        <div class="slider-range" id="restrictionsRange"></div>
                        <input type="range" class="slider-left" id="restrictionsMin" min="2009" max="2025" value="2009">
                        <input type="range" class="slider-right" id="restrictionsMax" min="2009" max="2025" value="2025">
                    </div>
                    <div class="slider-labels">
                        <span>2009</span>
                        <span>2025</span>
                    </div>
                    <div class="slider-value-display" id="restrictionsDisplay">2009 - 2025</div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="restrictionsChart"></canvas>
                </div>
                <div class="metric">
                    <span>Samlede restriktioner</span>
                    <span class="metric-value" id="totalRestrictions">--</span>
                    <span class="trend up" id="restrictionsTrend">--</span>
                </div>
                <div class="citation">
                    Source: Global Trade Alert Database
                </div>
            </div>

            <!-- Geopolitical Risk Index -->
            <div class="card">
                <h2>Geopolitisk Risiko Indeks</h2>
                <div class="slider-container">
                    <div class="slider-wrapper">
                        <div class="slider-track"></div>
                        <div class="slider-range" id="geoRange"></div>
                        <input type="range" class="slider-left" id="geoMin" min="0" max="67" value="0">
                        <input type="range" class="slider-right" id="geoMax" min="0" max="67" value="67">
                    </div>
                    <div class="slider-labels">
                        <span>Jan-20</span>
                        <span>Aug-25</span>
                    </div>
                    <div class="slider-value-display" id="geoDisplay">Jan-20 - Aug-25</div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="geoRiskChart"></canvas>
                </div>
                <div class="metric">
                    <span>Nuv√¶rende risikoniveau</span>
                    <span class="metric-value" id="currentRisk">--</span>
                    <span class="trend up" id="riskTrend">--</span>
                </div>
                <div class="citation">
                    Source: Caldara, Dario and Matteo Iacoviello (2022), "Measuring Geopolitical Risk"
                </div>
            </div>

            <!-- Trade Policy Uncertainty Index -->
            <div class="card">
                <h2>Handelspolitisk Usikkerhedsindeks</h2>
                <div class="slider-container">
                    <div class="slider-wrapper">
                        <div class="slider-track"></div>
                        <div class="slider-range" id="tpuRange"></div>
                        <input type="range" class="slider-left" id="tpuMin" min="0" max="67" value="0">
                        <input type="range" class="slider-right" id="tpuMax" min="0" max="67" value="67">
                    </div>
                    <div class="slider-labels">
                        <span>Jan-20</span>
                        <span>Aug-25</span>
                    </div>
                    <div class="slider-value-display" id="tpuDisplay">Jan-20 - Aug-25</div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="tpuChart"></canvas>
                </div>
                <div class="metric">
                    <span>Nuv√¶rende TPU niveau</span>
                    <span class="metric-value" id="currentTPU">--</span>
                    <span class="trend up" id="tpuTrend">--</span>
                </div>
                <div class="citation">
                    Source: Caldara, D., Iacoviello, M., Molligo, P., Prestipino, A., & Raffo, A. (2020). 
                    "The economic effects of trade policy uncertainty."
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const config = {
            staticDataPath: 'data/',
            githubRepo: 'mathov92/geofrag-dashboard',
            updateInterval: 300000
        };

        // Data Manager
        class DataManager {
            constructor() {
                this.cache = {};
                this.lastUpdate = null;
                this.originalData = null;
            }

            async loadStaticData() {
                try {
                    const data = {
                        tradeOpenness: {
                            years: [2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024],
                            World: [50.36, 49.23, 49.27, 50.92, 54.48, 56.52, 58.67, 59.05, 60.68, 52.19, 56.53, 59.66, 59.47, 58.75, 58.14, 55.77, 53.98, 55.70, 57.20, 55.96, 52.06, 56.85, 62.61, 58.37, 56.56],
                            EU: [71.57, 70.73, 68.44, 67.36, 70.40, 73.55, 77.98, 79.80, 80.78, 70.50, 78.27, 83.46, 85.07, 84.62, 85.34, 86.57, 85.61, 88.62, 90.34, 90.43, 83.69, 91.09, 103.63, 95.64, 92.15],
                            China: [39.01, 38.08, 42.19, 51.08, 58.64, 61.36, 63.57, 61.27, 56.71, 44.42, 49.85, 49.95, 47.48, 45.92, 44.07, 38.70, 36.18, 36.95, 36.89, 35.20, 34.04, 36.52, 37.44, 36.11, 37.20],
                            USA: [25.10, 22.97, 22.29, 22.63, 24.45, 25.64, 26.50, 27.20, 28.40, 24.80, 28.00, 30.50, 30.00, 29.50, 29.00, 27.50, 26.40, 27.00, 27.50, 26.90, 25.00, 27.30, 29.80, 28.20, 27.80],
                            India: [26.90, 25.99, 29.51, 30.59, 37.50, 42.00, 45.72, 45.69, 53.37, 46.27, 49.26, 55.62, 55.79, 53.84, 48.92, 41.92, 40.08, 40.74, 43.62, 39.91, 37.76, 45.42, 50.08, 44.99, 44.67],
                            Denmark: [83.04, 83.92, 84.48, 80.76, 82.01, 89.40, 97.43, 100.05, 104.47, 89.39, 94.39, 102.01, 104.36, 103.61, 103.21, 105.13, 101.45, 104.22, 108.81, 111.89, 104.43, 111.41, 131.54, 127.77, 128.64]
                        },
                        currencyData: {
                            labels: ['USD', 'EUR', 'CNY', 'JPY', 'GBP', 'Other'],
                            current: [59.2, 20.1, 12.3, 5.2, 4.9, 8.3]
                        },
                        fdiGdpData: {
                            years: [2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024, 2025],
                            USA: [2.43, 2.67, 1.87, 1.44, 1.65, 1.98, 2.11, 1.53, 1.42, 1.38, 1.35],
                            China: [2.23, 1.56, 1.35, 1.68, 1.34, 1.54, 1.95, 0.89, 0.52, 0.48, 0.45],
                            EU: [3.87, 2.94, 2.45, 1.82, 2.73, 3.45, 2.89, 2.13, 1.76, 1.82, 1.79]
                        },
                        tradeRestrictions: {
                            years: [2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024, 2025],
                            G7: [145, 187, 234, 276, 298, 342, 389, 456, 487, 542, 589, 687, 745, 812, 867, 923, 945],
                            BRICS: [89, 112, 156, 189, 213, 267, 298, 334, 378, 423, 468, 534, 589, 634, 689, 734, 756]
                        },
                        geoRiskIndex: {
                            dates: ['Jan-20', 'Feb-20', 'Mar-20', 'Apr-20', 'May-20', 'Jun-20', 'Jul-20', 'Aug-20', 'Sep-20', 'Oct-20', 'Nov-20', 'Dec-20',
                                   'Jan-21', 'Feb-21', 'Mar-21', 'Apr-21', 'May-21', 'Jun-21', 'Jul-21', 'Aug-21', 'Sep-21', 'Oct-21', 'Nov-21', 'Dec-21',
                                   'Jan-22', 'Feb-22', 'Mar-22', 'Apr-22', 'May-22', 'Jun-22', 'Jul-22', 'Aug-22', 'Sep-22', 'Oct-22', 'Nov-22', 'Dec-22',
                                   'Jan-23', 'Feb-23', 'Mar-23', 'Apr-23', 'May-23', 'Jun-23', 'Jul-23', 'Aug-23', 'Sep-23', 'Oct-23', 'Nov-23', 'Dec-23',
                                   'Jan-24', 'Feb-24', 'Mar-24', 'Apr-24', 'May-24', 'Jun-24', 'Jul-24', 'Aug-24', 'Sep-24', 'Oct-24', 'Nov-24', 'Dec-24',
                                   'Jan-25', 'Feb-25', 'Mar-25', 'Apr-25', 'May-25', 'Jun-25', 'Jul-25', 'Aug-25'],
                            values: [138.42, 75.96, 81.54, 69.34, 68.51, 71.23, 66.47, 65.47, 80.38, 76.08, 70.07, 64.07,
                                    77.42, 73.96, 78.62, 88.17, 93.01, 74.13, 58.42, 89.49, 80.70, 79.03, 86.57, 105.35,
                                    138.67, 216.16, 318.95, 191.14, 142.26, 130.71, 117.18, 132.86, 131.99, 143.16, 116.72, 111.20,
                                    104.27, 120.99, 105.38, 106.81, 108.47, 110.53, 107.45, 101.14, 98.63, 197.89, 156.70, 142.28,
                                    160.16, 146.60, 133.21, 163.74, 130.52, 112.88, 92.39, 140.76, 130.14, 130.69, 128.48, 142.13,
                                    112.33, 136.20, 172.85, 138.71, 165.41, 221.73, 134.99, 136.00]
                        },
                        tpuIndex: {
                            dates: ['Jan-20', 'Feb-20', 'Mar-20', 'Apr-20', 'May-20', 'Jun-20', 'Jul-20', 'Aug-20', 'Sep-20', 'Oct-20', 'Nov-20', 'Dec-20',
                                   'Jan-21', 'Feb-21', 'Mar-21', 'Apr-21', 'May-21', 'Jun-21', 'Jul-21', 'Aug-21', 'Sep-21', 'Oct-21', 'Nov-21', 'Dec-21',
                                   'Jan-22', 'Feb-22', 'Mar-22', 'Apr-22', 'May-22', 'Jun-22', 'Jul-22', 'Aug-22', 'Sep-22', 'Oct-22', 'Nov-22', 'Dec-22',
                                   'Jan-23', 'Feb-23', 'Mar-23', 'Apr-23', 'May-23', 'Jun-23', 'Jul-23', 'Aug-23', 'Sep-23', 'Oct-23', 'Nov-23', 'Dec-23',
                                   'Jan-24', 'Feb-24', 'Mar-24', 'Apr-24', 'May-24', 'Jun-24', 'Jul-24', 'Aug-24', 'Sep-24', 'Oct-24', 'Nov-24', 'Dec-24',
                                   'Jan-25', 'Feb-25', 'Mar-25', 'Apr-25', 'May-25', 'Jun-25', 'Jul-25', 'Aug-25'],
                            values: [1.40, 0.96, 0.61, 0.55, 0.67, 0.60, 0.57, 0.67, 0.68, 0.70, 0.70, 0.98,
                                    0.75, 0.37, 0.47, 0.48, 0.49, 0.49, 0.57, 0.39, 0.52, 0.56, 0.48, 0.37,
                                    0.47, 0.54, 0.54, 0.41, 0.63, 0.75, 0.67, 0.66, 0.49, 0.47, 0.49, 0.49,
                                    0.53, 0.44, 0.65, 0.34, 0.60, 0.52, 0.63, 0.60, 0.64, 0.44, 0.41, 0.65,
                                    0.70, 0.63, 0.82, 0.91, 0.94, 0.89, 1.01, 0.98, 1.29, 1.48, 3.73, 2.48,
                                    3.61, 4.70, 6.03, 11.51, 7.23, 4.73, 5.55, 5.76]
                        }
                    };
                    this.originalData = JSON.parse(JSON.stringify(data));
                    return data;
                } catch (error) {
                    console.error('Failed to load static data:', error);
                    return null;
                }
            }

            filterDataByYearRange(dataType, startYear, endYear) {
                const data = JSON.parse(JSON.stringify(this.originalData));
                
                switch(dataType) {
                    case 'trade':
                        const tradeStartIdx = data.tradeOpenness.years.findIndex(y => y >= startYear);
                        const tradeEndIdx = data.tradeOpenness.years.findIndex(y => y > endYear);
                        const tradeEnd = tradeEndIdx === -1 ? data.tradeOpenness.years.length : tradeEndIdx;
                        
                        if (tradeStartIdx === -1) return null;
                        
                        return {
                            years: data.tradeOpenness.years.slice(tradeStartIdx, tradeEnd),
                            World: data.tradeOpenness.World.slice(tradeStartIdx, tradeEnd),
                            EU: data.tradeOpenness.EU.slice(tradeStartIdx, tradeEnd),
                            China: data.tradeOpenness.China.slice(tradeStartIdx, tradeEnd),
                            USA: data.tradeOpenness.USA.slice(tradeStartIdx, tradeEnd),
                            India: data.tradeOpenness.India.slice(tradeStartIdx, tradeEnd),
                            Denmark: data.tradeOpenness.Denmark.slice(tradeStartIdx, tradeEnd)
                        };
                    
                    case 'fdi':
                        const fdiStartIdx = data.fdiGdpData.years.findIndex(y => y >= startYear);
                        const fdiEndIdx = data.fdiGdpData.years.findIndex(y => y > endYear);
                        const fdiEnd = fdiEndIdx === -1 ? data.fdiGdpData.years.length : fdiEndIdx;
                        
                        if (fdiStartIdx === -1) return null;
                        
                        return {
                            years: data.fdiGdpData.years.slice(fdiStartIdx, fdiEnd),
                            USA: data.fdiGdpData.USA.slice(fdiStartIdx, fdiEnd),
                            China: data.fdiGdpData.China.slice(fdiStartIdx, fdiEnd),
                            EU: data.fdiGdpData.EU.slice(fdiStartIdx, fdiEnd)
                        };
                    
                    case 'restrictions':
                        const resStartIdx = data.tradeRestrictions.years.findIndex(y => y >= startYear);
                        const resEndIdx = data.tradeRestrictions.years.findIndex(y => y > endYear);
                        const resEnd = resEndIdx === -1 ? data.tradeRestrictions.years.length : resEndIdx;
                        
                        if (resStartIdx === -1) return null;
                        
                        return {
                            years: data.tradeRestrictions.years.slice(resStartIdx, resEnd),
                            G7: data.tradeRestrictions.G7.slice(resStartIdx, resEnd),
                            BRICS: data.tradeRestrictions.BRICS.slice(resStartIdx, resEnd)
                        };
                    
                    case 'geo':
                        return {
                            dates: data.geoRiskIndex.dates.slice(startYear, endYear + 1),
                            values: data.geoRiskIndex.values.slice(startYear, endYear + 1)
                        };
                    
                    case 'tpu':
                        return {
                            dates: data.tpuIndex.dates.slice(startYear, endYear + 1),
                            values: data.tpuIndex.values.slice(startYear, endYear + 1)
                        };
                    
                    default:
                        return data;
                }
            }

            async fetchLiveData() {
                try {
                    const response = await fetch(`https://api.worldbank.org/v2/country/all/indicator/NY.GDP.MKTP.CD?format=json&date=2023`);
                    if (response.ok) {
                        const data = await response.json();
                        this.cache.liveGDP = data;
                        this.lastUpdate = new Date();
                        return true;
                    }
                } catch (error) {
                    console.log('Live data fetch failed, using cache');
                }
                return false;
            }
        }

        // Chart Manager
        class ChartManager {
            constructor() {
                this.charts = {};
            }

            initCharts(data) {
                // Trade Openness Chart - with adjusted height
                this.charts.tradeOpenness = new Chart(document.getElementById('tradeOpennessChart'), {
                    type: 'line',
                    data: {
                        labels: data.tradeOpenness.years,
                        datasets: [{
                            label: 'Verden',
                            data: data.tradeOpenness.World,
                            borderColor: '#4D4D4D',
                            backgroundColor: 'rgba(77, 77, 77, 0.1)',
                            tension: 0.0,
                            borderWidth: 2
                        }, {
                            label: 'EU',
                            data: data.tradeOpenness.EU,
                            borderColor: '#F5D547',
                            backgroundColor: 'rgba(245, 213, 71, 0.1)',
                            tension: 0.0,
                            borderWidth: 2
                        }, {
                            label: 'Danmark',
                            data: data.tradeOpenness.Denmark,
                            borderColor: '#C60C30',
                            backgroundColor: 'rgba(198, 12, 48, 0.1)',
                            tension: 0.0,
                            borderWidth: 2
                        }, {
                            label: 'Kina',
                            data: data.tradeOpenness.China,
                            borderColor: '#EE3A36',
                            backgroundColor: 'rgba(238, 58, 54, 0.1)',
                            tension: 0.0,
                            borderWidth: 2
                        }, {
                            label: 'Indien',
                            data: data.tradeOpenness.India,
                            borderColor: '#FF9933',
                            backgroundColor: 'rgba(255, 153, 51, 0.1)',
                            tension: 0.0,
                            borderWidth: 2
                        }, {
                            label: 'USA',
                            data: data.tradeOpenness.USA,
                            borderColor: '#005A8C',
                            backgroundColor: 'rgba(0, 90, 140, 0.1)',
                            tension: 0.0,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: { 
                                    boxWidth: 12,
                                    padding: 10,
                                    font: { size: 11 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '√Ör',
                                    font: { size: 11 }
                                },
                                ticks: { font: { size: 10 } }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Handel % af BNP',
                                    font: { size: 11 }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    },
                                    font: { size: 10 }
                                }
                            }
                        }
                    }
                });

                // Currency Chart
                this.charts.currency = new Chart(document.getElementById('currencyChart'), {
                    type: 'bar',
                    data: {
                        labels: data.currencyData.labels,
                        datasets: [{
                            label: 'Share %',
                            data: data.currencyData.current,
                            backgroundColor: ['#005A8C', '#F5D547', '#EE3A36', '#6FA8DC', '#2A6965', '#A61E4C']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true, 
                                max: 70,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });

                // FDI Chart
                this.charts.fdiGdp = new Chart(document.getElementById('fdiGdpChart'), {
                    type: 'line',
                    data: {
                        labels: data.fdiGdpData.years,
                        datasets: [{
                            label: 'USA',
                            data: data.fdiGdpData.USA,
                            borderColor: '#005A8C',
                            backgroundColor: 'rgba(0, 90, 140, 0.1)',
                            tension: 0.0
                        }, {
                            label: 'Kina',
                            data: data.fdiGdpData.China,
                            borderColor: '#EE3A36',
                            backgroundColor: 'rgba(238, 58, 54, 0.1)',
                            tension: 0.0
                        }, {
                            label: 'EU',
                            data: data.fdiGdpData.EU,
                            borderColor: '#F5D547',
                            backgroundColor: 'rgba(245, 213, 71, 0.1)',
                            tension: 0.0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: { 
                                    boxWidth: 12,
                                    padding: 8,
                                    font: { size: 11 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });

                // Trade Restrictions Chart
                this.charts.restrictions = new Chart(document.getElementById('restrictionsChart'), {
                    type: 'bar',
                    data: {
                        labels: data.tradeRestrictions.years,
                        datasets: [{
                            label: 'G7',
                            data: data.tradeRestrictions.G7,
                            backgroundColor: '#6FA8DC',
                            stack: 'Stack 0',
                        }, {
                            label: 'BRICS',
                            data: data.tradeRestrictions.BRICS,
                            backgroundColor: '#A61E4C',
                            stack: 'Stack 0',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: { 
                                    boxWidth: 12,
                                    font: { size: 11 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + ' restriktioner';
                                    },
                                    footer: function(tooltipItems) {
                                        let sum = 0;
                                        tooltipItems.forEach(function(tooltipItem) {
                                            sum += tooltipItem.parsed.y;
                                        });
                                        return 'Total: ' + sum + ' restriktioner';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: '√Ör',
                                    font: { size: 11 }
                                }
                            },
                            y: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'Antal restriktioner',
                                    font: { size: 11 }
                                }
                            }
                        }
                    }
                });

                // Geopolitical Risk Index Chart
                this.charts.geoRisk = new Chart(document.getElementById('geoRiskChart'), {
                    type: 'line',
                    data: {
                        labels: data.geoRiskIndex.dates,
                        datasets: [{
                            label: 'Geopolitisk Risiko Indeks',
                            data: data.geoRiskIndex.values,
                            borderColor: '#EE3A36',
                            backgroundColor: 'rgba(238, 58, 54, 0.1)',
                            tension: 0.0,
                            fill: true,
                            pointRadius: 1,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        let event = '';
                                        if (context.label === 'Feb-22' || context.label === 'Mar-22') {
                                            event = ' (Ukraine krig)';
                                        } else if (context.label === 'Oct-23') {
                                            event = ' (Israel-Gaza)';
                                        } else if (context.label === 'Jun-25') {
                                            event = ' (Top: 221.73)';
                                        }
                                        return 'Risiko indeks: ' + value.toFixed(2) + event;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                ticks: {
                                    maxTicksLimit: 10,
                                    font: { size: 10 },
                                    callback: function(val, index) {
                                        const label = this.getLabelForValue(val);
                                        return label && label.includes('Jan') ? label : '';
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Risiko Indeks',
                                    font: { size: 11 }
                                }
                            }
                        }
                    }
                });

                // Trade Policy Uncertainty Index Chart
                this.charts.tpu = new Chart(document.getElementById('tpuChart'), {
                    type: 'line',
                    data: {
                        labels: data.tpuIndex.dates,
                        datasets: [{
                            label: 'TPU Indeks (% af artikler)',
                            data: data.tpuIndex.values,
                            borderColor: '#2A6965',
                            backgroundColor: 'rgba(42, 105, 101, 0.1)',
                            tension: 0.0,
                            fill: true,
                            pointRadius: 1,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        let event = '';
                                        if (context.label === 'Nov-24') {
                                            event = ' (US valg)';
                                        } else if (context.label === 'Apr-25') {
                                            event = ' (Top: 11.51%)';
                                        }
                                        return 'TPU: ' + value.toFixed(2) + '%' + event;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                ticks: {
                                    maxTicksLimit: 10,
                                    font: { size: 10 },
                                    callback: function(val, index) {
                                        const label = this.getLabelForValue(val);
                                        return label && label.includes('Jan') ? label : '';
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Procent af artikler',
                                    font: { size: 11 }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value.toFixed(1) + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            updateChart(chartName, newData) {
                if (this.charts[chartName]) {
                    this.charts[chartName].data = newData;
                    this.charts[chartName].update();
                }
            }
        }

        // Global variables
        let dataManager;
        let chartManager;

        // Dual Range Slider Setup
        function setupDualRangeSlider(prefix, min, max, chartType, isMonthly = false) {
            const leftSlider = document.getElementById(prefix + 'Min');
            const rightSlider = document.getElementById(prefix + 'Max');
            const rangeBar = document.getElementById(prefix + 'Range');
            const displayElement = document.getElementById(prefix + 'Display');
            
            function updateSliders() {
                let minVal = parseInt(leftSlider.value);
                let maxVal = parseInt(rightSlider.value);
                
                // Prevent crossing
                if (minVal > maxVal - 1) {
                    leftSlider.value = maxVal - 1;
                    minVal = maxVal - 1;
                }
                if (maxVal < minVal + 1) {
                    rightSlider.value = minVal + 1;
                    maxVal = minVal + 1;
                }
                
                // Update range bar position
                const minPercent = ((minVal - min) / (max - min)) * 100;
                const maxPercent = ((maxVal - min) / (max - min)) * 100;
                rangeBar.style.left = minPercent + '%';
                rangeBar.style.width = (maxPercent - minPercent) + '%';
                
                // Update display
                if (isMonthly) {
                    const dates = dataManager.originalData[chartType === 'geo' ? 'geoRiskIndex' : 'tpuIndex'].dates;
                    displayElement.textContent = `${dates[minVal]} - ${dates[maxVal]}`;
                } else {
                    displayElement.textContent = `${minVal} - ${maxVal}`;
                }
                
                // Update chart
                updateChartByRange(chartType, minVal, maxVal);
            }
            
            leftSlider.addEventListener('input', updateSliders);
            rightSlider.addEventListener('input', updateSliders);
            
            // Initial update
            updateSliders();
        }

        // Update chart based on range selection
        function updateChartByRange(chartType, startValue, endValue) {
            const filteredData = dataManager.filterDataByYearRange(chartType, startValue, endValue);
            if (!filteredData) return;
            
            switch(chartType) {
                case 'trade':
                    chartManager.updateChart('tradeOpenness', {
                        labels: filteredData.years,
                        datasets: [{
                            label: 'Verden',
                            data: filteredData.World,
                            borderColor: '#4D4D4D',
                            backgroundColor: 'rgba(77, 77, 77, 0.1)',
                            tension: 0.0,
                            borderWidth: 2
                        }, {
                            label: 'EU',
                            data: filteredData.EU,
                            borderColor: '#F5D547',
                            backgroundColor: 'rgba(245, 213, 71, 0.1)',
                            tension: 0.0,
                            borderWidth: 2
                        }, {
                            label: 'Danmark',
                            data: filteredData.Denmark,
                            borderColor: '#C60C30',
                            backgroundColor: 'rgba(198, 12, 48, 0.1)',
                            tension: 0.0,
                            borderWidth: 2
                        }, {
                            label: 'Kina',
                            data: filteredData.China,
                            borderColor: '#EE3A36',
                            backgroundColor: 'rgba(238, 58, 54, 0.1)',
                            tension: 0.0,
                            borderWidth: 2
                        }, {
                            label: 'Indien',
                            data: filteredData.India,
                            borderColor: '#FF9933',
                            backgroundColor: 'rgba(255, 153, 51, 0.1)',
                            tension: 0.0,
                            borderWidth: 2
                        }, {
                            label: 'USA',
                            data: filteredData.USA,
                            borderColor: '#005A8C',
                            backgroundColor: 'rgba(0, 90, 140, 0.1)',
                            tension: 0.0,
                            borderWidth: 2
                        }]
                    });
                    updateTradeMetrics(filteredData);
                    break;
                
                case 'fdi':
                    chartManager.updateChart('fdiGdp', {
                        labels: filteredData.years,
                        datasets: [{
                            label: 'USA',
                            data: filteredData.USA,
                            borderColor: '#005A8C',
                            backgroundColor: 'rgba(0, 90, 140, 0.1)',
                            tension: 0.0
                        }, {
                            label: 'Kina',
                            data: filteredData.China,
                            borderColor: '#EE3A36',
                            backgroundColor: 'rgba(238, 58, 54, 0.1)',
                            tension: 0.0
                        }, {
                            label: 'EU',
                            data: filteredData.EU,
                            borderColor: '#F5D547',
                            backgroundColor: 'rgba(245, 213, 71, 0.1)',
                            tension: 0.0
                        }]
                    });
                    updateFdiMetrics(filteredData);
                    break;
                
                case 'restrictions':
                    chartManager.updateChart('restrictions', {
                        labels: filteredData.years,
                        datasets: [{
                            label: 'G7',
                            data: filteredData.G7,
                            backgroundColor: '#6FA8DC',
                            stack: 'Stack 0',
                        }, {
                            label: 'BRICS',
                            data: filteredData.BRICS,
                            backgroundColor: '#A61E4C',
                            stack: 'Stack 0',
                        }]
                    });
                    updateRestrictionsMetrics(filteredData);
                    break;
                
                case 'geo':
                    chartManager.updateChart('geoRisk', {
                        labels: filteredData.dates,
                        datasets: [{
                            label: 'Geopolitisk Risiko Indeks',
                            data: filteredData.values,
                            borderColor: '#EE3A36',
                            backgroundColor: 'rgba(238, 58, 54, 0.1)',
                            tension: 0.0,
                            fill: true,
                            pointRadius: 1,
                            pointHoverRadius: 5
                        }]
                    });
                    updateGeoMetrics(filteredData);
                    break;
                
                case 'tpu':
                    chartManager.updateChart('tpu', {
                        labels: filteredData.dates,
                        datasets: [{
                            label: 'TPU Indeks (% af artikler)',
                            data: filteredData.values,
                            borderColor: '#2A6965',
                            backgroundColor: 'rgba(42, 105, 101, 0.1)',
                            tension: 0.0,
                            fill: true,
                            pointRadius: 1,
                            pointHoverRadius: 5
                        }]
                    });
                    updateTpuMetrics(filteredData);
                    break;
            }
        }

        function updateTradeMetrics(data) {
            if (data && data.years.length > 0) {
                const currentYearIndex = data.years.length - 1;
                const prevYearIndex = currentYearIndex - 1;
                
                document.getElementById('worldTrade').textContent = 
                    data.World[currentYearIndex].toFixed(1) + '%';
                document.getElementById('euTrade').textContent = 
                    data.EU[currentYearIndex].toFixed(1) + '%';
                document.getElementById('chinaTrade').textContent = 
                    data.China[currentYearIndex].toFixed(1) + '%';
                document.getElementById('usaTrade').textContent = 
                    data.USA[currentYearIndex].toFixed(1) + '%';
                document.getElementById('indiaTrade').textContent = 
                    data.India[currentYearIndex].toFixed(1) + '%';
                document.getElementById('denmarkTrade').textContent = 
                    data.Denmark[currentYearIndex].toFixed(1) + '%';
                
                if (prevYearIndex >= 0) {
                    const worldChange = ((data.World[currentYearIndex] - data.World[prevYearIndex]) / 
                                        data.World[prevYearIndex] * 100).toFixed(1);
                    const euChange = ((data.EU[currentYearIndex] - data.EU[prevYearIndex]) / 
                                     data.EU[prevYearIndex] * 100).toFixed(1);
                    const chinaChange = ((data.China[currentYearIndex] - data.China[prevYearIndex]) / 
                                        data.China[prevYearIndex] * 100).toFixed(1);
                    const usaChange = ((data.USA[currentYearIndex] - data.USA[prevYearIndex]) / 
                                      data.USA[prevYearIndex] * 100).toFixed(1);
                    const indiaChange = ((data.India[currentYearIndex] - data.India[prevYearIndex]) / 
                                        data.India[prevYearIndex] * 100).toFixed(1);
                    const denmarkChange = ((data.Denmark[currentYearIndex] - data.Denmark[prevYearIndex]) / 
                                          data.Denmark[prevYearIndex] * 100).toFixed(1);
                    
                    document.getElementById('worldTradeTrend').textContent = (worldChange > 0 ? '+' : '') + worldChange + '%';
                    document.getElementById('euTradeTrend').textContent = (euChange > 0 ? '+' : '') + euChange + '%';
                    document.getElementById('chinaTradeTrend').textContent = (chinaChange > 0 ? '+' : '') + chinaChange + '%';
                    document.getElementById('usaTradeTrend').textContent = (usaChange > 0 ? '+' : '') + usaChange + '%';
                    document.getElementById('indiaTradeTrend').textContent = (indiaChange > 0 ? '+' : '') + indiaChange + '%';
                    document.getElementById('denmarkTradeTrend').textContent = (denmarkChange > 0 ? '+' : '') + denmarkChange + '%';
                    
                    document.getElementById('worldTradeTrend').className = worldChange > 0 ? 'trend up' : 'trend down';
                    document.getElementById('euTradeTrend').className = euChange > 0 ? 'trend up' : 'trend down';
                    document.getElementById('chinaTradeTrend').className = chinaChange > 0 ? 'trend up' : 'trend down';
                    document.getElementById('usaTradeTrend').className = usaChange > 0 ? 'trend up' : 'trend down';
                    document.getElementById('indiaTradeTrend').className = indiaChange > 0 ? 'trend up' : 'trend down';
                    document.getElementById('denmarkTradeTrend').className = denmarkChange > 0 ? 'trend up' : 'trend down';
                }
            }
        }

        function updateFdiMetrics(data) {
            const currentYear = data.years.length - 1;
            const prevYear = currentYear - 1;

            if (currentYear >= 0) {
                document.getElementById('usaFdi').textContent = 
                    data.USA[currentYear].toFixed(2) + '%';
                document.getElementById('chinaFdi').textContent = 
                    data.China[currentYear].toFixed(2) + '%';
                document.getElementById('euFdi').textContent = 
                    data.EU[currentYear].toFixed(2) + '%';

                if (prevYear >= 0) {
                    const usaTrend = ((data.USA[currentYear] - data.USA[prevYear]) / 
                                     data.USA[prevYear] * 100).toFixed(1);
                    const chinaTrend = ((data.China[currentYear] - data.China[prevYear]) / 
                                       data.China[prevYear] * 100).toFixed(1);
                    const euTrend = ((data.EU[currentYear] - data.EU[prevYear]) / 
                                    data.EU[prevYear] * 100).toFixed(1);

                    document.getElementById('usaTrend').textContent = (usaTrend > 0 ? '+' : '') + usaTrend + '%';
                    document.getElementById('chinaTrend').textContent = (chinaTrend > 0 ? '+' : '') + chinaTrend + '%';
                    document.getElementById('euTrend').textContent = (euTrend > 0 ? '+' : '') + euTrend + '%';

                    document.getElementById('usaTrend').className = usaTrend > 0 ? 'trend up' : 'trend down';
                    document.getElementById('chinaTrend').className = chinaTrend > 0 ? 'trend up' : 'trend down';
                    document.getElementById('euTrend').className = euTrend > 0 ? 'trend up' : 'trend down';
                }
            }
        }

        function updateRestrictionsMetrics(data) {
            const currentYearIndex = data.years.length - 1;
            const prevYearIndex = currentYearIndex - 1;

            if (currentYearIndex >= 0) {
                const currentTotal = data.G7[currentYearIndex] + data.BRICS[currentYearIndex];
                document.getElementById('totalRestrictions').textContent = currentTotal.toLocaleString();

                if (prevYearIndex >= 0) {
                    const prevTotal = data.G7[prevYearIndex] + data.BRICS[prevYearIndex];
                    const restrictionChange = currentTotal - prevTotal;
                    document.getElementById('restrictionsTrend').textContent = (restrictionChange > 0 ? '+' : '') + restrictionChange;
                    document.getElementById('restrictionsTrend').className = restrictionChange > 0 ? 'trend up' : 'trend down';
                }
            }
        }

        function updateGeoMetrics(data) {
            const values = data.values;
            if (values.length > 0) {
                const currentRisk = values[values.length - 1];
                document.getElementById('currentRisk').textContent = currentRisk.toFixed(1);

                if (values.length > 1) {
                    const previousRisk = values[values.length - 2];
                    const riskChange = ((currentRisk - previousRisk) / previousRisk * 100).toFixed(1);
                    document.getElementById('riskTrend').textContent = (riskChange > 0 ? '+' : '') + riskChange + '%';
                    document.getElementById('riskTrend').className = riskChange > 0 ? 'trend up' : 'trend down';
                }
            }
        }

        function updateTpuMetrics(data) {
            const values = data.values;
            if (values.length > 0) {
                const currentTPU = values[values.length - 1];
                document.getElementById('currentTPU').textContent = currentTPU.toFixed(2) + '%';

                if (values.length > 1) {
                    const previousTPU = values[values.length - 2];
                    const tpuChange = ((currentTPU - previousTPU) / previousTPU * 100).toFixed(1);
                    document.getElementById('tpuTrend').textContent = (tpuChange > 0 ? '+' : '') + tpuChange + '%';
                    document.getElementById('tpuTrend').className = tpuChange > 0 ? 'trend up' : 'trend down';
                }
            }
        }

        function updateAllMetrics(data) {
            // Update currency share (doesn't change with filter)
            document.getElementById('usdShare').textContent = 
                data.currencyData.current[0] + '%';
            
            // Update all other metrics
            updateTradeMetrics(data.tradeOpenness);
            updateFdiMetrics(data.fdiGdpData);
            updateRestrictionsMetrics(data.tradeRestrictions);
            updateGeoMetrics(data.geoRiskIndex);
            updateTpuMetrics(data.tpuIndex);
        }

        // Initialize Dashboard
        async function initDashboard() {
            dataManager = new DataManager();
            chartManager = new ChartManager();

            const staticData = await dataManager.loadStaticData();
            if (!staticData) {
                document.getElementById('dataStatus').textContent = 'Failed to load data';
                return;
            }

            chartManager.initCharts(staticData);
            updateAllMetrics(staticData);

            // Setup dual range sliders
            setupDualRangeSlider('trade', 2000, 2024, 'trade');
            setupDualRangeSlider('fdi', 2015, 2025, 'fdi');
            setupDualRangeSlider('restrictions', 2009, 2025, 'restrictions');
            setupDualRangeSlider('geo', 0, 67, 'geo', true);
            setupDualRangeSlider('tpu', 0, 67, 'tpu', true);

            // Setup country selector dropdown
            setupCountrySelector();

            // Try to fetch live data
            const liveSuccess = await dataManager.fetchLiveData();
            
            if (liveSuccess) {
                document.getElementById('dataStatus').textContent = 'Live data';
                document.getElementById('liveIndicator').style.display = 'inline-block';
            } else {
                document.getElementById('dataStatus').textContent = '';
            }
            
            document.getElementById('lastUpdate').textContent = 
                new Date().toLocaleTimeString('da-DK');

            // Set up periodic updates
            setInterval(async () => {
                const updated = await dataManager.fetchLiveData();
                if (updated) {
                    document.getElementById('lastUpdate').textContent = 
                        new Date().toLocaleTimeString('da-DK');
                }
            }, config.updateInterval);
        }

        // Country selector dropdown functionality
        function setupCountrySelector() {
            const dropdownBtn = document.getElementById('countryDropdownBtn');
            const dropdown = document.getElementById('countryDropdown');
            
            // Toggle dropdown on button click
            dropdownBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdown.classList.toggle('show');
                // Update button text to show arrow direction
                if (dropdown.classList.contains('show')) {
                    dropdownBtn.innerHTML = 'V√¶lg lande ‚ñ≤';
                } else {
                    dropdownBtn.innerHTML = 'V√¶lg lande ‚ñº';
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function() {
                dropdown.classList.remove('show');
                dropdownBtn.innerHTML = 'V√¶lg lande ‚ñº';
            });
            
            // Prevent dropdown from closing when clicking inside it
            dropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Handle checkbox changes
            const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateTradeChartVisibility();
                });
            });
        }

        // Update trade chart visibility based on selected countries
        function updateTradeChartVisibility() {
            const checkboxes = document.querySelectorAll('#countryDropdown input[type="checkbox"]');
            const selectedCountries = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedCountries.push(checkbox.value);
                }
            });
            
            // Update chart datasets visibility
            const chart = chartManager.charts.tradeOpenness;
            if (chart) {
                chart.data.datasets.forEach(dataset => {
                    let countryKey = dataset.label;
                    // Map Danish labels to data keys
                    if (countryKey === 'Verden') countryKey = 'World';
                    else if (countryKey === 'Danmark') countryKey = 'Denmark';
                    else if (countryKey === 'Kina') countryKey = 'China';
                    else if (countryKey === 'Indien') countryKey = 'India';
                    
                    dataset.hidden = !selectedCountries.includes(countryKey);
                });
                chart.update();
            }
            
            // Update metrics visibility
            updateMetricsVisibility(selectedCountries);
        }

        // Update metrics visibility based on selected countries
        function updateMetricsVisibility(selectedCountries) {
            const metricsMap = {
                'World': 'worldTrade',
                'EU': 'euTrade',
                'China': 'chinaTrade',
                'USA': 'usaTrade',
                'India': 'indiaTrade',
                'Denmark': 'denmarkTrade'
            };
            
            Object.keys(metricsMap).forEach(country => {
                const metricElement = document.getElementById(metricsMap[country]);
                if (metricElement && metricElement.parentElement) {
                    metricElement.parentElement.style.display = 
                        selectedCountries.includes(country) ? 'flex' : 'none';
                }
            });
            
            // Adjust grid columns based on visible metrics
            const visibleCount = selectedCountries.length;
            const metricsGrid = document.querySelector('.wide-metrics-grid');
            if (metricsGrid) {
                if (visibleCount <= 3) {
                    metricsGrid.style.gridTemplateColumns = `repeat(${visibleCount}, 1fr)`;
                } else {
                    metricsGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(140px, 1fr))';
                }
            }
        }

        // Start the dashboard
        window.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
